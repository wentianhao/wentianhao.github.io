---
title: 线程池
katex: false
tags: java
categories: java
abbrlink: 226
date: 2021-08-18 16:07:41
---
详细分析线程池

使用线程池的好处：
- 降低资源消耗：通过重复使用已创建的线程降低线程创建和销毁的消耗
- 提高资源利用率：当任务到达时，可以不需要创建线程就立即执行
- 提高线程的可管理性：线程池可以统一分配，调优和监控
<!-- more -->

## Executor框架
Executor框架是Java5之后引进的，通过Executor来启动线程比使用Thread的start更好，除了方便管理，效率更好(用线程池实现，节约开销)外，还有助于 this逃逸问题。

**this逃逸**：在构造函数返回之前其他线程就持有该对象的引用，调用尚未构造完全的对象的方法可能引发令人疑惑的错误。

Executor框架不仅包括线程池的管理，还提供线程工厂、队列以及拒绝策略等。

### Executor框架结构
#### 任务(Runnable / Callable)
执行任务需要实现的Runnable接口或Callable接口。这俩接口的实现类均可被ThreadPoolExecutor 或 ScheduledThreadPoolExecutor执行。

#### 任务执行(Executor)
任务执行机制的核心接口Executor,以及ExecutorService接口。ThreadPoolExecutor和ScheduledThreadPoolExecutor类都实现了ExecutorService接口

ScheduledThreadPoolExecutor 实际上是继承了 ThreadPoolExecutor 并实现了 ScheduledExecutorService ，而 ScheduledExecutorService 又实现了 ExecutorService

**ThreadPoolExecutor**
```java
//AbstractExecutorService实现了ExecutorService接口
public class ThreadPoolExecutor extends AbstractExecutorService
```

**ScheduledThreadPoolExecutor**
```java
//ScheduledExecutorService继承ExecutorService接口
public class ScheduledThreadPoolExecutor
        extends ThreadPoolExecutor
        implements ScheduledExecutorService

```
![任务的执行相关接口](https://whh.plus/images/任务的执行相关接口.png)

#### 异步计算的结果(Future)
Future接口以及Future接口的实现类FutureTask类都可代表异步计算的结果

当把Runnable接口或Callable皆苦的实现类提交给ThreadPoolExecutor或ScheduledThreadPoolExecutor执行(调用submit()方法会返回一个FutureTask对象)

### Executor框架使用
![Executor框架的使用示意图](https://whh.plus/images/Executor框架的使用示意图.png)
1. 主线程首先创建实现Runnable或Callable接口的任务对象
2. 把创建完成的实现Runnable或Callable接口的任务对象提交到ExecutorService执行：ExecutorService.execute（Runnable command））或者也可以把 Runnable 对象或Callable 对象提交给 ExecutorService 执行（ExecutorService.submit（Runnable task）或 ExecutorService.submit（Callable <T> task））。
3. 如果执行Executor.submit(..),ExecutorService将返回一个Future接口的对象
4. 最后，主线程执行FutureTask.get()方法来等待任务执行完成，主线程也可以执行 FutureTask.cancel（boolean mayInterruptIfRunning）来取消此任务的执行。

## ThreadPoolExecutor类简单介绍
线程池实现类ThreadPoolExecutor是Executor框架最核心的类

### 构造方法

